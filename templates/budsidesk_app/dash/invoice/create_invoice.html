{% extends 'budsidesk_app/base.html' %}
{% load static %}
{% block content %}

<form method="post" action="{% url 'invoice_save' %}" id="invoice-form">
  {% csrf_token %}
  
  <div style="max-width: 1200px; margin: 32px auto; padding: 0 20px;">
    <h1 style="text-align: center; color: #2a3550; margin-bottom: 8px;">Create New Invoice</h1>
    <p style="text-align: center; color: #6b7a90; margin-bottom: 32px;">You have created {{ profile.invoice_count }} invoices so far.</p>

    <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
      <!-- Invoice Header -->
      <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
        <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">Invoice Details</h2>
        <div style="padding: 18px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
            <div>
              <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Number</label>
              <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 600; color: #4B49AC;">
                INV-{{ profile.invoice_count|add:1|stringformat:"06d" }}
              </div>
            </div>
            <div>
              <label for="invoice_date" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Date *</label>
              <input type="date" id="invoice_date" name="date" required 
                     value="{{ form_data.date|default:'' }}"
                     style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>
            <div>
              <label for="client" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Client *</label>
              
              {% if prefilled_contact %}
                <input type="text" id="client" name="contact" 
                      value="{{ prefilled_contact.name }}" readonly
                      style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px; background:#f8f9fa; font-weight:600;">
                <small style="color:#6b7a90; display:block; margin-top:6px;">
                  From favorite customer. <a href="{% url 'invoice_create' %}" style="color:#4B49AC;">Change</a>
                </small>
              {% else %}
                <input type="text" id="client" name="contact" required placeholder="Client name"
                      value="{{ form_data.contact|default:'' }}"
                      style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
              {% endif %}
            </div>
          </div>

          <!-- Client Contact Information Section -->
          <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label for="client_address" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Address *</label>
              {% if prefilled_contact %}
                <textarea id="client_address" name="address" required placeholder="Client address"
                          style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px; min-height: 80px;"
                >{{ prefilled_contact.address|default:'' }}</textarea>
              {% else %}
                <textarea id="client_address" name="address" required placeholder="Client address"
                          style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px; min-height: 80px;"
                >{{ form_data.address|default:'' }}</textarea>
              {% endif %}
            </div>
            
            <div>
              <div style="margin-bottom: 16px;">
                <label for="client_email" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Email *</label>
                {% if prefilled_contact %}
                  <input type="email" id="client_email" name="email" required placeholder="client@example.com"
                         value="{{ prefilled_contact.email|default:'' }}"
                         style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                {% else %}
                  <input type="email" id="client_email" name="email" required placeholder="client@example.com"
                         value="{{ form_data.email|default:'' }}"
                         style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                {% endif %}
              </div>
              
              <div>
                <label for="client_cellphone" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Phone Number (Optional)</label>
                {% if prefilled_contact %}
                  <input type="tel" id="client_cellphone" name="cellphone" placeholder="+1 (555) 123-4567"
                         value="{{ prefilled_contact.cellphone|default:'' }}"
                         style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                {% else %}
                  <input type="tel" id="client_cellphone" name="cellphone" placeholder="+1 (555) 123-4567"
                         value="{{ form_data.cellphone|default:'' }}"
                         style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Project Field -->
          <div style="margin-top: 16px;">
            <label for="project" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Project</label>
            <input type="text" id="project" name="project" placeholder="Project name"
                   value="{{ form_data.project|default:'' }}"
                   style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
          </div>
        </div>
      </div>

      <!-- Concepts Table -->
      <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18);">
          <h2 style="margin: 0; color: #4B49AC; font-size: 18px;"></h2>
          <button type="button" id="add-concept" style="background: #4B49AC; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-plus"></i> Add Concept
          </button>
        </div>
        <div style="padding: 18px;">
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;" id="concepts-table">
              <thead>
                <tr style="background: #f8f9ff;">
                  <th style="text-align: left; padding: 12px; border-bottom: 2px solid rgba(75, 73, 172, 0.18); width: 45%;">Description</th>
                  <th style="text-align: left; padding: 12px; border-bottom: 2px solid rgba(75, 73, 172, 0.18); width: 15%;">Quantity</th>
                  <th style="text-align: left; padding: 12px; border-bottom: 2px solid rgba(75, 73, 172, 0.18); width: 20%;">Unit Price (€)</th>
                  <th style="text-align: left; padding: 12px; border-bottom: 2px solid rgba(75, 73, 172, 0.18); width: 15%;">Amount (€)</th>
                  <th style="text-align: center; padding: 12px; border-bottom: 2px solid rgba(75, 73, 172, 0.18); width: 5%;"></th>
                </tr>
              </thead>
              <tbody>
                <!-- Initial row -->
                <tr class="concept-row">
                  <td style="padding: 8px;">
                    <input type="text" name="concept_description[]" placeholder="Item description" 
                           value="{{ form_data.concept_description.0|default:'' }}"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                  </td>
                  <td style="padding: 8px;">
                    <input type="number" name="concept_quantity[]" step="0.01" value="{{ form_data.concept_quantity.0|default:'1' }}" class="quantity" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                  </td>
                  <td style="padding: 8px;">
                    <input type="number" name="concept_unit_price[]" step="0.01" value="{{ form_data.concept_unit_price.0|default:'0.00' }}" class="unit-price" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                  </td>
                  <td style="padding: 8px;"><span class="amount">0.00</span></td>
                  <td style="padding: 8px; text-align: center;">
                    <button type="button" class="remove-row" 
                            style="background: #ff4757; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;">×</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- VAT and Totals -->
      <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
        <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">VAT & Totals</h2>
        <div style="padding: 18px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <div style="margin-bottom: 16px;">
                <label for="vat_rate" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">VAT Rate</label>
                <select id="vat_rate" name="vat_rate" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                  <option value="0" {% if form_data.vat_rate == "0" %}selected{% endif %}>0% (Zero Rate)</option>
                  <option value="9" {% if form_data.vat_rate == "9" %}selected{% endif %}>9% (Second Reduced Rate)</option>
                  <option value="13.5" {% if form_data.vat_rate == "13.5" %}selected{% endif %}>13.5% (Reduced Rate)</option>
                  <option value="23" {% if not form_data.vat_rate or form_data.vat_rate == "23" %}selected{% endif %}>23% (Standard Rate)</option>
                </select>
              </div>
              <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Subtotal:</span>
                  <span id="subtotal-display">€0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>VAT (<span id="vat-rate-display">23%</span>):</span>
                  <span id="vat-amount-display">€0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; padding-top: 8px; border-top: 1px solid #ddd;">
                  <span>Total:</span>
                  <span id="total-display">€0.00</span>
                </div>
              </div>

              <!-- Hidden fields for form submission -->
              <input type="hidden" id="subtotal-input" name="subtotal" value="{{ form_data.subtotal|default:'0' }}">
              <input type="hidden" id="vat-amount-input" name="vat_amount" value="{{ form_data.vat_amount|default:'0' }}">
            </div>
            <div>
              <div style="margin-bottom: 16px;">
                <label for="payment_terms" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Payment Terms</label>
                <select id="payment_terms" name="payment_terms" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                  <option value="7" {% if form_data.payment_terms == "7" %}selected{% endif %}>Due in 7 days</option>
                  <option value="14" {% if form_data.payment_terms == "14" %}selected{% endif %}>Due in 14 days</option>
                  <option value="30" {% if not form_data.payment_terms or form_data.payment_terms == "30" %}selected{% endif %}>Due in 30 days</option>
                  <option value="0" {% if form_data.payment_terms == "0" %}selected{% endif %}>Due on receipt</option>
                </select>
              </div>
              <div>
                <label for="notes" style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Notes</label>
                <textarea id="notes" name="notes" rows="4" placeholder="Additional notes..." 
                          style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">{{ form_data.notes|default:'' }}</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 24px;">
        <button type="submit" id="save-invoice" style="border: 0; border-radius: 12px; padding: 12px 24px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, #7DA0FA, #4B49AC); color: #fff; flex: 1;">
          <i class="fas fa-save"></i> Create Invoice
        </button>
        <a href="{% url 'invoice_list' %}" style="display: inline-block; background: #fff; border: 2px solid #4B49AC; color: #4B49AC; border-radius: 12px; padding: 12px 14px; font-weight: 700; text-decoration: none;">
          <i class="fas fa-arrow-left"></i> Back to List
        </a>
      </div>
    </div>
  </div>
</form>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default only if no existing data
    {% if not form_data.date %}
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoice_date').value = today;
    {% endif %}
    
    // Restore dynamic concept rows if form data exists
    restoreConceptRows();
    
    // Add concept row
    document.getElementById('add-concept').addEventListener('click', function() {
      addConceptRow();
    });
    
    // Remove row event delegation
    document.getElementById('concepts-table').addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-row')) {
        const row = e.target.closest('tr');
        if (document.querySelectorAll('.concept-row').length > 1) {
          row.remove();
          calculateTotals();
        } else {
          alert('You must have at least one concept.');
        }
      }
    });
    
    // Attach events to existing rows
    document.querySelectorAll('.concept-row').forEach(row => {
      attachRowEvents(row);
    });
    
    // Calculate totals when any input changes in the concepts table
    document.getElementById('concepts-table').addEventListener('input', function(e) {
      if (e.target.classList.contains('quantity') || e.target.classList.contains('unit-price')) {
        calculateRow(e.target.closest('tr'));
        calculateTotals();
      }
    });
    
    // Calculate totals when VAT rate changes
    document.getElementById('vat_rate').addEventListener('change', function() {
      document.getElementById('vat-rate-display').textContent = this.value + '%';
      calculateTotals();
    });
    
    // Form submission validation
    document.getElementById('invoice-form').addEventListener('submit', function(e) {
      const clientField = document.getElementById('client');
      const addressField = document.getElementById('client_address');
      const emailField = document.getElementById('client_email');
      
      if (!clientField.value.trim()) {
        e.preventDefault();
        alert('Please enter a client name.');
        clientField.focus();
        return;
      }

      if (!addressField.value.trim()) {
        e.preventDefault();
        alert('Please enter a client address.');
        addressField.focus();
        return;
      }

      if (!emailField.value.trim()) {
        e.preventDefault();
        alert('Please enter a client email.');
        emailField.focus();
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailField.value)) {
        e.preventDefault();
        alert('Please enter a valid email address.');
        emailField.focus();
        return;
      }

      // Validate at least one concept has description
      const descriptions = document.querySelectorAll('input[name="concept_description[]"]');
      let hasDescription = false;
      descriptions.forEach(input => {
        if (input.value.trim()) {
          hasDescription = true;
        }
      });

      if (!hasDescription) {
        e.preventDefault();
        alert('Please enter at least one concept description.');
        return;
      }

      // Update hidden fields with current totals
      const subtotal = parseFloat(document.getElementById('subtotal-display').textContent.replace('€', ''));
      const vatAmount = parseFloat(document.getElementById('vat-amount-display').textContent.replace('€', ''));
      document.getElementById('subtotal-input').value = subtotal;
      document.getElementById('vat-amount-input').value = vatAmount;

      // Show loading state
      const submitBtn = document.getElementById('save-invoice');
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Invoice...';
      submitBtn.disabled = true;
    });
    
    // Initial calculation
    calculateTotals();
  });
  
  function restoreConceptRows() {
    {% if form_data.concept_description %}
      const descriptions = {{ form_data.concept_description|safe }};
      const quantities = {{ form_data.concept_quantity|default:"[]"|safe }};
      const unitPrices = {{ form_data.concept_unit_price|default:"[]"|safe }};
      
      // Start from index 1 since the first row already exists
      for (let i = 1; i < descriptions.length; i++) {
        addConceptRow(
          descriptions[i] || '',
          quantities[i] || '1',
          unitPrices[i] || '0.00'
        );
      }
    {% endif %}
  }
  
  function addConceptRow(description = '', quantity = '1', unitPrice = '0.00') {
    const table = document.getElementById('concepts-table').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    newRow.className = 'concept-row';
    newRow.innerHTML = `
      <td style="padding: 8px;">
        <input type="text" name="concept_description[]" placeholder="Item description" 
               value="${description}"
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
      </td>
      <td style="padding: 8px;">
        <input type="number" name="concept_quantity[]" step="0.01" value="${quantity}" class="quantity" 
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
      </td>
      <td style="padding: 8px;">
        <input type="number" name="concept_unit_price[]" step="0.01" value="${unitPrice}" class="unit-price" 
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
      </td>
      <td style="padding: 8px;"><span class="amount">${(parseFloat(quantity) * parseFloat(unitPrice)).toFixed(2)}</span></td>
      <td style="padding: 8px; text-align: center;">
        <button type="button" class="remove-row" 
                style="background: #ff4757; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;">×</button>
      </td>
    `;
    
    // Add event listeners to new inputs
    attachRowEvents(newRow);
    calculateTotals();
  }
  
  function attachRowEvents(row) {
    const quantityInput = row.querySelector('.quantity');
    const priceInput = row.querySelector('.unit-price');
    
    quantityInput.addEventListener('input', function() {
      calculateRow(row);
    });
    
    priceInput.addEventListener('input', function() {
      calculateRow(row);
    });
  }
  
  function calculateRow(row) {
    const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
    const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
    const amount = quantity * unitPrice;
    row.querySelector('.amount').textContent = amount.toFixed(2);
  }
  
  function calculateTotals() {
    let subtotal = 0;
    
    // Calculate subtotal from all rows
    document.querySelectorAll('.concept-row').forEach(row => {
      const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
      const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
      const amount = quantity * unitPrice;
      subtotal += amount;
    });
    
    // Get VAT rate
    const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
    const vatAmount = subtotal * (vatRate / 100);
    const total = subtotal + vatAmount;
    
    // Update displays
    document.getElementById('subtotal-display').textContent = '€' + subtotal.toFixed(2);
    document.getElementById('vat-amount-display').textContent = '€' + vatAmount.toFixed(2);
    document.getElementById('total-display').textContent = '€' + total.toFixed(2);
  }
</script>

{% endblock %}