{% extends 'budsidesk_app/base.html' %}
{% load static %}
{% block content %}

<form method="post" id="expense-form">
  {% csrf_token %}

  <div style="max-width: 1200px; margin: 32px auto; padding: 0 20px;">
    <h1 style="text-align: center; color: #2a3550; margin-bottom: 8px;">Edit Expense</h1>
    <p style="text-align: center; color: #6b7a90; margin-bottom: 24px;">
      Expense No: <strong style="color:#4B49AC">{{ invoice.invoice_number }}</strong>
    </p>

    <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">

      <!-- Expense Header -->
      <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
        <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">
          Expense Details
        </h2>
        <div style="padding: 18px;">
          <!-- OCR notice - ACTUALIZADO CON DESCUENTO -->
          <div style="background: #e8f5e8; padding: 12px; border-radius: 10px; margin-bottom: 16px; border-left: 4px solid #01BF1F; color:#245a2b;">
            <strong>OCR processed — please verify and correct all amounts:</strong><br>
            Total: €{{ invoice.total|floatformat:2 }} · VAT: €{{ invoice.vat_amount|floatformat:2 }} · Subtotal: €{{ invoice.subtotal|floatformat:2 }}
            {% if invoice.ocr_data.discount and invoice.ocr_data.discount != "0.00" %}
              · Discount: -€{{ invoice.ocr_data.discount|floatformat:2 }}
            {% endif %}
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
            <div>
              <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Supplier *</label>
              <input type="text" name="supplier" required
                     value="{{ invoice.contact.name }}"
                     placeholder="Supplier name"
                     style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>
            <div>
              <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Date *</label>
              <input type="date" name="date" required
                     value="{{ invoice.date|date:'Y-m-d' }}"
                     style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>
            <div>
              <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Category *</label>
              <select name="category" required
                      style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                <option value="">Select a category</option>
                <option value="Office" {% if invoice.category == "Office" %}selected{% endif %}>Office</option>
                <option value="Equipment" {% if invoice.category == "Equipment" %}selected{% endif %}>Equipment</option>
                <option value="Travel" {% if invoice.category == "Travel" %}selected{% endif %}>Travel</option>
                <option value="Marketing" {% if invoice.category == "Marketing" %}selected{% endif %}>Marketing</option>
                <option value="Development" {% if invoice.category == "Development" %}selected{% endif %}>Development</option>
                <option value="Communication" {% if invoice.category == "Communication" %}selected{% endif %}>Communication</option>
                <option value="Financial" {% if invoice.category == "Financial" %}selected{% endif %}>Financial</option>
                <option value="Payment Fees" {% if invoice.category == "Payment Fees" %}selected{% endif %}>Payment Fees</option>
                <option value="Insurance" {% if invoice.category == "Insurance" %}selected{% endif %}>Insurance</option>
                <option value="Miscellaneous" {% if invoice.category == "Miscellaneous" %}selected{% endif %}>Miscellaneous</option>
              </select>
            </div>
          </div>

          <div style="margin-top: 16px;">
            <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Project (optional)</label>
            <select name="project"
                    style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
              <option value="">No project</option>
              {% for project in existing_projects %}
                <option value="{{ project }}" {% if invoice.project == project %}selected{% endif %}>{{ project }}</option>
              {% endfor %}
            </select>
            <small style="color:#6b7a90; display:block; margin-top:6px;">Assign this expense to a project for better tracking.</small>
          </div>
        </div>
      </div>

      <!-- NUEVA SECCIÓN: Discounts & Adjustments -->
      <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
        <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">
          Discounts & Adjustments
        </h2>
        <div style="padding: 18px;">
          
          <!-- Campo para descuento global -->
          <div style="margin-bottom: 16px;">
            <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">
              Global Discount (€)
            </label>
            <input type="number" id="global-discount" name="global_discount" step="0.01" 
                   value="{% if invoice.ocr_data.discount and invoice.ocr_data.discount != '0.00' %}{{ invoice.ocr_data.discount|floatformat:2 }}{% else %}0.00{% endif %}"
                   placeholder="0.00"
                   style="width: 100%; max-width: 200px; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            <small style="color:#6b7a90; display:block; margin-top:6px;">
              Enter any global discount applied to this invoice (use negative values for discounts)
            </small>
          </div>

          <!-- Selector de términos para el total -->
          <div>
            <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">
              Total Amount Label
            </label>
            <select id="total-label" name="total_label"
                    style="width: 100%; max-width: 200px; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
              <option value="total" {% if not invoice.paid or invoice.paid == invoice.total %}selected{% endif %}>Total</option>
              <option value="paid" {% if invoice.paid and invoice.paid != invoice.total %}selected{% endif %}>Paid</option>
              <option value="due">Due</option>
            </select>
            <small style="color:#6b7a90; display:block; margin-top:6px;">
              Select how the final amount is labeled in your invoice
            </small>
          </div>

        </div>
      </div>

      <!-- Amounts Section - Simplified -->
      <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
        <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">Amounts & VAT</h2>
        <div style="padding: 18px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <div style="margin-bottom: 16px;">
                <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">VAT Rate</label>
                <select id="vat_rate" name="vat_rate"
                        style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75,73,172,0.35); border-radius: 10px;">
                  <option value="0" {% if invoice.vat_amount == 0 %}selected{% endif %}>0%</option>
                  <option value="13">13%</option>
                  <option value="23" {% if invoice.vat_amount > 0 %}selected{% endif %}>23%</option>
                </select>
              </div>
              
              <!-- Amount inputs -->
              <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid rgba(75, 73, 172, 0.15);">
                <div style="margin-bottom: 16px;">
                  <label style="font-weight: 700; color: #4B49AC; font-size: 16px; display: block; margin-bottom: 8px;">Total Amount (€) *</label>
                  <input type="number" id="total-input" name="total" step="0.01" 
                         value="{{ invoice.total|floatformat:2 }}" required
                         style="width: 100%; padding: 12px; border: 2px solid #4B49AC; border-radius: 8px; font-weight: 700; font-size: 16px; text-align: center;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                  <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px;">Subtotal (€) *</label>
                    <input type="number" id="subtotal-input" name="subtotal" step="0.01" 
                           value="{{ invoice.subtotal|floatformat:2 }}" required
                           style="width: 100%; padding: 10px; border: 1px solid rgba(75,73,172,0.35); border-radius: 6px; text-align: center;">
                  </div>
                  <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px;">VAT Amount (€) *</label>
                    <input type="number" id="vat-amount-input" name="vat_amount" step="0.01" 
                           value="{{ invoice.vat_amount|floatformat:2 }}" required
                           style="width: 100%; padding: 10px; border: 1px solid rgba(75,73,172,0.35); border-radius: 6px; text-align: center;">
                  </div>
                </div>

                <!-- Single auto-calculate button -->
                <button type="button" id="auto-calculate" 
                        style="background: linear-gradient(135deg, #7DA0FA, #4B49AC); color: white; border: none; border-radius: 8px; padding: 12px 20px; font-weight: 600; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <i class="fas fa-calculator"></i> Auto-calculate VAT from Total
                </button>
                <small style="color:#6b7a90; display:block; margin-top:8px; text-align: center;">
                  Calculates VAT and subtotal automatically based on total and VAT rate.
                </small>
              </div>
            </div>

            <div>
              <label style="font-weight: 600; color: #2a3550; font-size: 14px; display: block; margin-bottom: 8px;">Notes</label>
              <textarea name="notes" rows="8" placeholder="Add any notes about this expense..."
                        style="width: 100%; padding: 12px; border: 1px solid rgba(75,73,172,0.35); border-radius: 10px; height: 200px;">{{ invoice.notes|default:"" }}</textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
        <button type="submit" name="confirm"
                style="border: 0; border-radius: 12px; padding: 12px 24px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, #7DA0FA, #4B49AC); color: #fff; flex: 1;">
          <i class="fas fa-save"></i> Confirm & Save Expense
        </button>
        <a href="{% url 'expense_list' %}"
           style="display: inline-block; background: #fff; border: 2px solid #4B49AC; color: #4B49AC; border-radius: 12px; padding: 12px 14px; font-weight: 700; text-decoration: none;">
          <i class="fas fa-arrow-left"></i> Back to Expenses
        </a>
      </div>
    </div>
  </div>
</form>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Auto-calculate VAT from total
  document.getElementById('auto-calculate').addEventListener('click', autoCalculateVAT);

  // Update subtotal and VAT when total or rate changes
  document.getElementById('total-input').addEventListener('input', updateCalculationsWithDiscount);
  document.getElementById('vat_rate').addEventListener('change', updateCalculationsWithDiscount);
  
  // ✅ NUEVO: Agregar event listeners para descuentos
  document.getElementById('global-discount').addEventListener('input', updateCalculationsWithDiscount);
  document.getElementById('total-label').addEventListener('change', updateTotalLabel);

  // Submit button loading state
  document.getElementById('expense-form').addEventListener('submit', function() {
    const btn = this.querySelector('button[type="submit"]');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    btn.disabled = true;
  });

  // Initial calculation
  updateCalculationsWithDiscount();
});

function autoCalculateVAT() {
  const total = parseFloat(document.getElementById('total-input').value) || 0;
  const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
  const discount = parseFloat(document.getElementById('global-discount').value) || 0;

  if (total > 0 && vatRate > 0) {
    // Calculate subtotal and VAT considering discount
    const subtotalBeforeDiscount = total / (1 + vatRate/100);
    const subtotal = subtotalBeforeDiscount + discount; // El subtotal incluye el descuento
    const vatAmount = total - subtotalBeforeDiscount;
    
    document.getElementById('subtotal-input').value = subtotal.toFixed(2);
    document.getElementById('vat-amount-input').value = vatAmount.toFixed(2);
  } else {
    alert('Please enter a valid total amount and select a VAT rate first.');
  }
}

function updateCalculationsWithDiscount() {
  const subtotal = parseFloat(document.getElementById('subtotal-input').value) || 0;
  const discount = parseFloat(document.getElementById('global-discount').value) || 0;
  const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
  
  // Calcular subtotal después de descuento
  const subtotalAfterDiscount = Math.max(0, subtotal - discount);
  
  // Calcular VAT basado en el subtotal después del descuento
  const vatAmount = subtotalAfterDiscount * (vatRate / 100);
  const total = subtotalAfterDiscount + vatAmount;
  
  // Actualizar campos
  document.getElementById('vat-amount-input').value = vatAmount.toFixed(2);
  document.getElementById('total-input').value = total.toFixed(2);
  
  // Actualizar display del label seleccionado
  updateTotalLabel();
}

function updateTotalLabel() {
  const totalLabel = document.getElementById('total-label').value;
  const totalValue = parseFloat(document.getElementById('total-input').value) || 0;
  
  // Aquí podrías actualizar cómo se muestra el total en la UI si es necesario
  console.log(`Total labeled as: ${totalLabel} = €${totalValue.toFixed(2)}`);
}

// Función original mantenida para compatibilidad
function updateCalculations() {
  const total = parseFloat(document.getElementById('total-input').value) || 0;
  const subtotal = parseFloat(document.getElementById('subtotal-input').value) || 0;
  const vatAmount = parseFloat(document.getElementById('vat-amount-input').value) || 0;
  
  // If user manually changes subtotal or VAT, update total
  if (subtotal > 0 || vatAmount > 0) {
    const calculatedTotal = subtotal + vatAmount;
    if (Math.abs(calculatedTotal - total) > 0.01) { // Only update if there's a significant difference
      document.getElementById('total-input').value = calculatedTotal.toFixed(2);
    }
  }
}
</script>

{% endblock %}